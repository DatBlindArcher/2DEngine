package character.controller;

import java.awt.Color;
import java.awt.event.KeyEvent;
import java.nio.ByteBuffer;

import org.w3c.dom.Node;

import com.codedisaster.steamworks.SteamException;
import com.codedisaster.steamworks.SteamNetworking.P2PSend;

import game.engine.*;
import game.engine.Physics.CharacterController;
import game.engine.UI.GUI;
import multiplayer.game.SteamManager;
import multiplayer.game.SteamPlayer;

public class MultiplayerCharacter extends CharacterController
{
	public boolean isMine;
	public static int score = 0;
	float speed = 200f;

	public MultiplayerCharacter(boolean mine) 
	{
		isMine = mine;
	}
	
	public MultiplayerCharacter(Node xml)
	{
		super(xml);
	}
	
	public void update()
	{
		if(!isMine) return;
		Vector2 delta = new Vector2();
		
		if(Input.getKey(KeyEvent.VK_W) || Input.getKey(KeyEvent.VK_UP))
		{
			delta.y--;
		}
		
		if(Input.getKey(KeyEvent.VK_S) || Input.getKey(KeyEvent.VK_DOWN))
		{
			delta.y++;
		}
		
		if(Input.getKey(KeyEvent.VK_A) || Input.getKey(KeyEvent.VK_LEFT))
		{
			delta.x--;
		}
		
		if(Input.getKey(KeyEvent.VK_D) || Input.getKey(KeyEvent.VK_RIGHT))
		{
			delta.x++;
		}
		
		if(Input.getKey(KeyEvent.VK_SHIFT))
		{
			if(Input.getMouseButton(0))
			{
				GameObject.create(new GameObject("Bullet", "Projectile", new Component[] { new Projectile(), new Image("/Images/Circle.png", 1, Color.orange) }), transform.position.addtemp(transform.forward().multiply(32f)), transform.rotation, new Vector2(0.5f, 0.5f));
			}
		}
		
		else
		{
			if(Input.getMouseButtonDown(0))
			{
				GameObject.create(new GameObject("Bullet", "Projectile", new Component[] { new Projectile(), new Image("/Images/Circle.png", 1, Color.orange) }), transform.position.addtemp(transform.forward().multiply(32f)), transform.rotation, new Vector2(0.5f, 0.5f));
			}
		}
		
		Vector2 mouse = Input.getMousePosition();
		mouse.add(new Vector2(-Screen.width / 2f, -Screen.height / 2f));
		float angle = (float)Math.toDegrees(Math.atan(mouse.y / mouse.x));
		if(mouse.x > 0f) angle += 180f;
		transform.rotation = angle;
		
		super.move(delta.multiply(Time.deltaTime * speed));
	}
	
	public void onFixedUpdate()
	{
		if(isMine)
		{
			int offset = 0;
			byte[] buffer = new byte[32];
			buffer[offset++] = (byte)transform.position.x;
			buffer[offset++] = (byte)(transform.position.y>>8);
			buffer[offset++] = (byte)(transform.rotation>>16);
			buffer[offset++] = (byte)(value>>24);
			
			ByteBuffer data = null;
			
			for(SteamPlayer player : SteamManager.instance.lobby.players)
			{
				try 
				{
					SteamManager.instance.networking.sendP2PPacket(player.ID, data, 0, data.limit(), P2PSend.Reliable, 0);
				} 
				
				catch (SteamException e) 
				{
					e.printStackTrace();
				}
			}
		}
	}
	
	public void onGUI()
	{
		GUI.setColor(Color.black);
		GUI.label(new Rect((int)(Screen.width / 2f) - 5, (int)(Screen.height / 2f) - 3, 10, 6), Integer.toString(score));
	}
}